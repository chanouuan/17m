<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>十七平创意摄影工作室</title>
    <link href="<?=$tpl_dir?>/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="<?=$tpl_dir?>/css/common2.css?v=1" rel="stylesheet" type="text/css">    
    <link href="<?=$tpl_dir?>/css/notice.css" rel="stylesheet" type="text/css">
    <link href="<?=$tpl_dir?>/css/user.css?v=1" rel="stylesheet" type="text/css">

    <style type="text/css">
    
    </style>
</head>
<body ontouchstart>
    <div class="app">
        <div class="toolbar">
            <div class="toolbar-logo"><img src="<?=$tpl_dir?>/imgs/logo.png"></div>
            <div class="toolbar-menu" id="toolbar-menu"><a href="javascript:void(0)" data-role="icon-ment" class="icon-menu"></a></div>
            <div class="toolbar-back" id="toolbar-back"><a href="javascript:void(0);"><i class="icon-arrow-left"></i>上一步</a></div>
            <div class="toolbar-location" id="toolbar-location"><a href="javascript:void(0);"><i class="icon-location-white"></i><strong data-role="location"></strong><i data-role="arrow" class="icon-arrow-down"></i></a></div>
        </div>
        <div class="app-body">
            <form id="user-form" method="post" action="">
                <div class="wrap">
                    <h2 class="icon-profile">个人资料</h2>
                </div>
                <p class="promise-tips">我们保证，绝不会向第三方透露你的资料信息。</p>
                <div class="wrap user-profile">
                    <div class="user-info">
                        <ul>
                            <li class="user-name">
                                <div class="uname-box">
                                    <label>*你的姓名</label>
                                    <span class="ui-input">
                                        <input autocomplete="off" type="text" class="order-username" name="nickname" value="<?=$userinfo['nickname']?>">
                                        <a href="javascript:;" class="ui-input-clear icon-fail-fill"></a>
                                    </span>
                                   
                                </div>
                              
                                <div class="uname-sex">
                                    <label>*你的性别</label>
                                    <input type="hidden" name="gender" value="<?=$userinfo['gender']?>">
                                    <a  <?php if($userinfo['gender']==2){ ?>class=active<?php } ?>  data-sex="2" href="javascript:;">女士</a>
                                    <a <?php if($userinfo['gender']==1){ ?>class=active<?php } ?> data-sex="1" href="javascript:;">先生</a>
                                </div>
                             
                            </li>
                            <p style="color:#ccc">为了确保顺利拍摄，请填写真实姓名和电话。</p>
                            <li class="user-tel">
                                <div class="utel-box">
                                    <label>*你的手机号码</label>
                                    <span class="ui-input">
                                        <input autocomplete="off" type="number" maxlength="11" class="order-telphone" name="telephone" tel="<?=$userinfo['telephone']?>" value="<?=$userinfo['telephone']?>">
                                        <a href="javascript:;" class="ui-input-clear icon-fail-fill"></a>
                                    </span>
                                    <a href="javascript:;" class="ut-getcode">获取验证码</a>
                                </div>
                                <div class="utel-code">
                                    <label>*验证码</label>
                                    <span class="ui-input">
                                        <input autocomplete="off" maxlength="4" placeholder="4位数字" type="number" class="order-telcode" name="code" value="">
                                        <a href="javascript:;" class="ui-input-clear icon-fail-fill"></a>
                                    </span>
                                </div>
                            </li>
                            
                        </ul>
                    </div>
                </div>
                <div class="nb-dialog save-success" id="dialog-success">
                    <div class="mask"></div>
                    <div class="dialog-box">
                        <i class="icon-success-line"></i>
                        <p>保存成功</p>
                    </div>
                </div>
                <div class="action user-profile-btn">
                    <a href="javascript:history.back();" class="nb-btn nb-btn-default">取&nbsp;&nbsp;消</a>
                    <a href="javascript:;" id="save-profile" class="nb-btn nb-btn-disable">保存</a>
                </div>
            </form>
            <div id="page-mask" class="page-mask"></div>
        </div>
    </div>
<!-- 菜单 start -->
    <div id="toolbar-submenu" class="toolbar-submenu">
        <ul class="ts-menu" id="ts-menu">
            <li><a href="?c=project&a=book"><i class="icon-order"></i>开始预约</a></li>
            <li><a href="?c=order&a=myorder"><i class="icon-orderlist"></i>我的订单</a></li>
            <li><a href="?c=order&a=Personal"><i class="icon-profile"></i>个人资料</a></li>
            <li><a href="?c=order&a=negative"><i class="icon-vip2"></i>个人底片</a></li>
            <li><a href="?c=order&a=address"><i class="icon-store-info1"></i>门店地址</a></li>
            <li><a href="?c=order&a=help"><i class="icon-notice"></i>拍摄须知</a></li>
        </ul>
        <div class="mask"></div>
    </div>
    <div id="alert-dialog" class="alert-dialog" style="display: none;">
        <div class="alert-box">
            <a href="javascript:$('#alert-dialog').hide();" class="close icon-close"></a>
            <div class="alert-header">
                <i class="icon-warning"></i>
            </div>
            <div class="alert-content">
            </div>
            <div class="alert-footer">
                <a href="javascript:void(0)" class="action-btn">好</a>
            </div>
        </div>
        <div class="mask"></div>
    </div>
<!-- 菜单 end -->

<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="<?=APPLICATION_URL?>/public/js/jquery.min.js"></script>
    <script>
    $('#toolbar-menu').click(function(){
        var mentEl = $(this).find('[data-role="icon-ment"]');
        $('#toolbar-submenu').toggle();
        if (mentEl.hasClass('icon-menu')) {
            mentEl.removeClass('icon-menu');
            mentEl.addClass('icon-arrow-right');
        } else {
            mentEl.addClass('icon-menu');
            mentEl.removeClass('icon-arrow-right');
        }

        setTimeout(function() {
            $('#ts-menu').toggleClass('ts-menu-active');
        }, 0);
    });


    $('#toolbar-back').click(function(){

        // if($('#store-multi-name').length && $('#store-box-open').length )
        // {
        //     if(!$('#store-box-open').hasClass('store-box-open-show'))
        //     {
        //         storeMultiNameClicked();
        //         return ;
        //     }
        //     else
        //     {
        //         $('#store-box-open').removeClass('store-box-open-show');
        //         history.back();
        //     }
        // }


        if($('#schedules-calender-open').length)
        {
            if(!$('#schedules-calender-open').hasClass('schedules-calender-open-show'))
            {
                $('#schedules-calender-open').addClass('schedules-calender-open-show');
                return ;
            }
        }



        history.back();
    });






    $('#toolbar-submenu').on('click', '.mask', function() {
        $('#toolbar-submenu').hide();
        var mentEl = $('#toolbar-menu').find('[data-role="icon-ment"]');
        if (mentEl.hasClass('icon-menu')) {
            mentEl.removeClass('icon-menu');
            mentEl.addClass('icon-arrow-right');
        } else {
            mentEl.addClass('icon-menu');
            mentEl.removeClass('icon-arrow-right');
        }
        $('#ts-menu').removeClass('ts-menu-active');
    });


    if (window['runParams'] && runParams.toolbarLocationShow) {
        var toolbarLocationElm = $('#toolbar-location');
        toolbarLocationElm.show();
        toolbarLocationElm.on('click', function() {
            $(this).find('[data-role="arrow"]').toggleClass('icon-arrow-down');
            $(this).find('[data-role="arrow"]').toggleClass('icon-arrow-up');
            $('#toolbar-citys').toggleClass('toolbar-citys-show');
        });
    }

    function customAlert(status, message, actionText, callback) {
        var statusClass = '';
        if(status == 'error') {
            statusClass = 'error';
        }
        $('#alert-dialog').addClass(statusClass);
        $('#alert-dialog .alert-content').html(message);
        $('#alert-dialog .action-btn').html(actionText);
        $('#alert-dialog .action-btn').on('click', function() {
            if (callback != null) {
                callback($('#alert-dialog'));
            }
            $('#alert-dialog').hide();
        });
        $('#alert-dialog').show();
        var h = $('#alert-dialog .alert-box').height();
        $('#alert-dialog .alert-box').height(h);
        $('#alert-dialog .alert-box').css('margin-top', -h/2)
    }

    $('.mask').on('click', function() {
        $(this).parent().hide();
    });
    </script>



    <script>
    // input获得焦点时显示删除按钮
    (function () {
        $('.ui-input').find('input').click(function (e) {
            $('.ui-input-active').removeClass('ui-input-active');

            if ($(this).parents('.utel-box').size() > 0) {
                $(this).parents('.utel-box').addClass('utel-box-active');
            } else {
                $('.utel-box-active').removeClass('utel-box-active');
                $(this).parent().addClass('ui-input-active');
            }
            e.stopPropagation();
        }).end().find('.ui-input-clear').click(function (e) {
            $(this).parent().addClass('ui-input-active').find('input').val('');
            $(this).parents('.utel-code').removeClass('ui-input-success');
            if ($('#order-coupon input').size() > 0) {
                $('#order-coupon input').keyup();
            }
            e.stopPropagation();
        });
        $('body').click(function () {
            $('.ui-input-active').each(function () {
                $(this).removeClass('ui-input-active');
            })
        })
    })();

    // 手机号码校验
    $('.order-telphone').bind('input', function () {
        var tel = $.trim($(this).val());

        if (tel.length == 11) {
            $(this).parents('.ui-input-error').removeClass('ui-input-error');
        }
    });

    // 选择性别
    $('.user-info .uname-sex a').click(function () {
        var el = $(this);
        el.parent().find('.active').removeClass('active');
        el.addClass('active');
        el.parent().find('input').val(el.data('sex'));
    });
    // 显示手机验证码
    (function () {
        var canSendCode = false;
        // 验证码倒计时
        var countDown = function (el, callback) {
            var count = el.data('countdown');
            var timer = setInterval(function () {
                if (count <= 1) {
                    clearInterval(timer);
                    callback();
                } else {
                    el.removeData('countdown');
                    el.html('重新获取(' + count + ')');
                    count--;
                }
            }, 1000);
        }

        $('.user-tel .utel-box')
                .find('input').bind('input', function () {
                    var el = $(this);
                    el.val(el.val().replace(/[^\d]/g, ''));
                    var originPhone = el.attr('tel');
                    var phone = el.val();
                    if (phone.length == 11) {
                        // 修改了手机号或者以前没有输入过手机号时需要验证
                        if (originPhone == '' || phone != originPhone) {
                            canSendCode = true;
                            el.parents('.user-tel').find('.utel-code')
                                    .removeClass('ui-input-success')
                                    .removeClass('ui-input-error');
                            el.parents('.utel-box').find('.ut-getcode').removeClass('ut-getcode-disable');
                            el.parents('.user-tel').find('.utel-code').show();
                        } else {
                            canSendCode = false;
                            el.parents('.utel-box').find('.ut-getcode').addClass('ut-getcode-disable');
                            el.parents('.user-tel').find('.utel-code').hide();
                        }
                    }
                }).keyup()
                .end().find('.ut-getcode').click(function () {
                    var el = $(this);
                    var tel = el.parent().find('input').val();
                    if (tel.length === 11 && canSendCode) {
                        canSendCode = false;
                        el.addClass('ut-getcode-disable');
                        $.getJSON('?c=order&a=sendcode&tel=' + tel, function (data) {
                            if (!data.success) {
                                canSendCode = true;
                                customAlert('error', data.msg, '好');
                            } else {
                                el.data('countdown', 60);
                                countDown(el, function () {
                                    el.html('获取验证码');
                                    canSendCode = true;
                                });
                            }
                        });
                    }
                });

        // 校验验证码
        $('.utel-code input').bind('input', function () {
            var el = $(this);
            var code = el.val();
            var tel = el.parents('.user-tel').find('.utel-box input').val();
            if (code.length == 4) {
                $.getJSON('?c=order&a=validatecode&tel=' + tel + '&code=' + code, function (data) {
                    if (data.errorcode !== 0) {
                        el.parents('.utel-code').removeClass('ui-input-success').addClass('ui-input-error');
                    } else {
                        el.parents('.utel-code').removeClass('ui-input-error').addClass('ui-input-success');
                    }
                });
            }
        });
    })();

    $('#user-form').on('change', 'input', function () {
        if ($(this).val() != '') {
            $('#save-profile').removeClass('nb-btn-disable');
            $('#save-profile').addClass('nb-btn-primary');
        } else {
            $('#save-profile').removeClass('nb-btn-primary');
            $('#save-profile').addClass('nb-btn-disable');
        }
    });

    // 邮箱
    (function () {
        // 显示推荐邮箱列表
        var showSuggest = function (el, email) {
            var suffix = ['qq.com', '163.com', '126.com', 'hotmail.com', 'gmail.com', '189.cn'];
            var list = [];
            var offset = el.offset();
            var name = email.split('@').length > 1 ? email.split('@')[1] : null;
            var node = $('#email-suggest');

            if (node.length == 0) {
                node = $('<div id="email-suggest" />');
                $('body').append(node);
                node.on('click', 'a', function () {
                    if (el.size() > 0) {
                        el.val($(this).html()).focus().blur()
                                .parents('.user-email').removeClass('ui-input-error');
                    }
                    node.hide();
                })
            }

            $.each(suffix, function (index, site) {
                if (name && name != '') {
                    if (site.indexOf(name) > -1) {
                        list.push('<a href="javascript:;">' + email.split('@')[0] + '@' + site + '</a>');
                    }
                } else {
                    list.push('<a href="javascript:;">' + email.split('@')[0] + '@' + site + '</a>');
                }
            });
            node.css({
                top: offset.top + offset.height,
                left: offset.left,
                width: offset.width
            }).html(list.join('')).show();
        }
        $('.user-email input').bind('input', function () {
            var email = $(this).val();
            if (/^(\w)+(\.\w+)*@(\w)*?$/.test(email)) {
                showSuggest($(this), email);
            }
        })
    })();

    function hasError() {
        var hasError = false;
        $('.user-info').each(function () {
            var name = $(this).find('.order-username').val();
            var originPhone = $(this).find('.order-telphone').attr('tel');
            var phone = $(this).find('.order-telphone').val();
            var code = $(this).find('.order-telcode').val();
         

            if (name == '') {
                hasError = true;
                $(this).find('.order-username').focus();
                $(this).find('.uname-box').addClass('ui-input-error');
                return false;
            } else {
                $(this).find('.uname-box').removeClass('ui-input-error');
            }

            if (phone.length != 11) {
                hasError = true;
                $(this).find('.order-telphone').focus();
                $(this).find('.utel-box').addClass('ui-input-error');
                return false;
            } else {
                $(this).find('.utel-box').removeClass('ui-input-error');

                // 校验验证码
                if (!originPhone || originPhone == '' || originPhone != phone) {
                    if (!$(this).find('.utel-code').hasClass('ui-input-success')) {
                        hasError = true;
                        $(this).find('.order-code').focus();
                        $(this).find('.utel-code').addClass('ui-input-error');
                        return false;
                    }
                }
            }

   
        });
        return hasError;
    }

    $('.user-info').last().find('.order-mail').blur(function () {
        if (!hasError()) {
            $('#confirm-order').removeClass('order-confirm-disable');
        } else {
            $('#confirm-order').addClass('order-confirm-disable');
        }
    }).each(function () {
        if (/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test($(this).val())) {
            $(this).focus().blur();
        }
    });

    $('#save-profile').click(function () {
        if (!hasError()) {
            $.post('?c=order&a=saveuserinfo', $('#user-form').serialize(), function (result) {
                if (result.errorcode !== 0) {
                    customAlert('error', result.data, '好');
                } else {
                    $('#dialog-success').show();
                    setTimeout(function () {
                    	<?php if($_GET['referer']){ ?>
                    	window.location.href = '<?=htmlspecialchars_decode(urldecode($_GET['referer']))?>';
                        <?php }else{ ?>
                        window.location.href = window.location.href;
                        <?php } ?>
                    }, 1000);
                }
            }, "json");
        }
    });
    </script>

</body>
</html>